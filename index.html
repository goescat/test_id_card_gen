<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>測試圖片產生器（兩張底圖 + 指定欄位 + 條碼）</title>
  <style>
    :root{
      --gap: 16px;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --bg: #f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: saturate(180%) blur(6px);
      background: rgba(248,250,252,0.8); border-bottom:1px solid var(--line);
      padding: 12px 16px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    header h1{ font-size:18px; margin:0; font-weight:700; }
    main{ padding: 16px; max-width: 1200px; margin: 0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 1024px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius: 16px; box-shadow: 0 4px 16px rgba(2,6,23,0.04); }
    .card h2{ margin:0; padding: 14px 16px; border-bottom:1px solid var(--line); font-size: 16px; }
    .card .content{ padding: 16px; display:grid; gap:12px; }
    .row{ display:grid; grid-template-columns: 120px 1fr; gap: 10px; align-items:center; }
    .row.inline{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    label{ font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="file"], select{
      appearance:none; width:100%; background:white; border:1px solid var(--line); border-radius: 10px;
      padding: 8px 10px; font-size: 14px; color:var(--ink);
    }
    input[type="checkbox"]{ transform: translateY(1px); }
    .hint{ font-size: 12px; color:var(--muted); }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    button{ cursor:pointer; border:1px solid var(--line); background:#0ea5e9; color:white; padding:8px 12px; border-radius: 10px; font-weight:600; font-size: 14px; }
    button.secondary{ background:white; color:var(--ink); }
    canvas{ width:100%; height:auto; border:1px dashed var(--line); border-radius: 12px; background:white; }
    .pill{ display:inline-flex; align-items:center; gap:8px; background:#f1f5f9; padding:6px 10px; border-radius:999px; font-size:12px; color:#0f172a; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <!-- 條碼產生器（Code128） -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <header>
    <h1>測試圖片產生器（兩張底圖 + 指定欄位 + 條碼）</h1>
    <span class="pill">需求：第一圖 1-1〜1-5、第二圖 2-1〜2-3 + 2-4 條碼（取自 1-5）</span>
  </header>

  <main>
    <div class="grid">
      <!-- 圖一 -->
      <section class="card" id="panel1">
        <h2>第一圖：固定底圖 + 特定位置（1-1〜1-5）</h2>
        <div class="content">
          <div class="row"><label>底圖</label><div class="hint">已固定，請在程式常數 <span class="kbd">BASE1_SRC</span> 更換路徑（預設：<span class="kbd">base1.png</span>）。</div></div>
          <div class="row"><label>1-1（文字）</label><input id="f11" type="text" value="示例文字 A" /></div>
          <div class="row"><label>1-2（數字）</label><input id="f12" type="text" inputmode="numeric" pattern="[0-9]*" value="123" /></div>
          <div class="row"><label>1-3（數字）</label><input id="f13" type="text" inputmode="numeric" pattern="[0-9]*" value="456" /></div>
          <div class="row"><label>1-4（數字）</label><input id="f14" type="text" inputmode="numeric" pattern="[0-9]*" value="789" /></div>
          <div class="row">
            <label>1-5（文字，可隨機）</label>
            <div class="btns">
              <input id="f15" type="text" value="" style="min-width:240px" />
              <button type="button" id="rand15">隨機產生</button>
              <span class="hint">此值將用於第二圖 2-4 條碼</span>
            </div>
          </div>
          <div class="row">
            <label>輔助</label>
            <div class="btns">
              <label><input type="checkbox" id="toggleCross" checked /> 顯示參考十字</label>
            </div>
          </div>
          <canvas id="canvas1" width="1000" height="600"></canvas>
          <div class="btns">
            <button type="button" id="dl1">下載第一圖 PNG</button>
            <button type="button" class="secondary" id="clear1">清空欄位（保留底圖）</button>
          </div>
        </div>
      </section>

      <!-- 圖二 -->
      <section class="card" id="panel2">
        <h2>第二圖：固定底圖 + 特定位置（2-1〜2-3）+ 2-4 條碼（取自 1-5）</h2>
        <div class="content">
          <div class="row"><label>底圖</label><div class="hint">已固定，請在程式常數 <span class="kbd">BASE2_SRC</span> 更換路徑（預設：<span class="kbd">base2.png</span>）。</div></div>
          <div class="row"><label>2-1（文字）</label><input id="f21" type="text" value="示例文字 B1" /></div>
          <div class="row"><label>2-2（文字）</label><input id="f22" type="text" value="示例文字 B2" /></div>
          <div class="row"><label>2-3（文字）</label><input id="f23" type="text" value="示例文字 B3" /></div>

          <div class="row">
            <label>2-4（條碼）</label>
            <div>
              <div class="hint">會自動使用 第一圖 1-5 的值產生 Code128 條碼並顯示於預設位置。</div>
              <div class="row inline" style="margin-top:8px">
                <label class="hint">X%</label><input id="bcx" type="number" min="0" max="100" step="1" value="8" />
                <label class="hint">Y%</label><input id="bcy" type="number" min="0" max="100" step="1" value="48" />
              </div>
              <div class="row inline" style="margin-top:8px">
                <label class="hint">寬%</label><input id="bcw" type="number" min="1" max="100" step="1" value="60" />
                <label class="hint">高%</label><input id="bch" type="number" min="1" max="100" step="1" value="20" />
              </div>
            </div>
          </div>

          <canvas id="canvas2" width="1000" height="600"></canvas>
          <div class="btns">
            <button type="button" id="dl2">下載第二圖 PNG</button>
            <button type="button" class="secondary" id="clear2">清空欄位（保留底圖）</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 隱藏用：條碼離屏畫布 -->
  <canvas id="barcodeTmp" width="600" height="160" style="display:none"></canvas>

<script>
(function(){
  // 固定版面配置（使用「百分比」定位，會依底圖解析度自動縮放）
  const layout1 = {
    '1-1': { x: 8,  y: 15, fontH: 6, bold:true },   // 文字
    '1-2': { x: 8,  y: 27, fontH: 5 },              // 數字
    '1-3': { x: 28, y: 27, fontH: 5 },              // 數字
    '1-4': { x: 48, y: 27, fontH: 5 },              // 數字
    '1-5': { x: 8,  y: 37, fontH: 5, bold:true },   // 文字（亦提供隨機）
  };

  const layout2 = {
    '2-1': { x: 8,  y: 15, fontH: 6, bold:true },
    '2-2': { x: 8,  y: 27, fontH: 5 },
    '2-3': { x: 8,  y: 37, fontH: 5 },
    // 2-4 條碼使用單獨控制（百分比） bcX, bcY, bcW, bcH
  };

  // Helpers
  const $ = (sel) => document.querySelector(sel);
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

  function randomCode(len=12){
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789';
    let s = '';
    for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  function makePlaceholder(ctx, W, H){
    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#e2e8f0';
    for(let y=0;y<H;y+=40){ for(let x=0;x<W;x+=40){ if(((x/40 + y/40)|0)%2===0) ctx.fillRect(x,y,40,40); } }
    ctx.fillStyle = '#475569';
    ctx.font = '700 24px system-ui';
    ctx.fillText('(未設定底圖)', 20, 40);
  }

  function drawText(ctx, text, conf, W, H){
    const x = Math.round(conf.x/100 * W);
    const y = Math.round(conf.y/100 * H);
    const fontPx = Math.max(10, Math.round(conf.fontH/100 * H));
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillStyle = '#111827';
    ctx.font = `${conf.bold? '700':'400'} ${fontPx}px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC`;
    ctx.fillText(text||'', x, y);
    return {x,y};
  }

  function cross(ctx, x, y){
    ctx.save();
    ctx.strokeStyle = '#94a3b8';
    ctx.setLineDash([4,4]);
    ctx.beginPath();
    ctx.moveTo(x-10,y); ctx.lineTo(x+10,y);
    ctx.moveTo(x,y-10); ctx.lineTo(x,y+10);
    ctx.stroke();
    ctx.restore();
  }

  // DOM refs
  const c1 = $('#canvas1');
  const c2 = $('#canvas2');
  const ctx1 = c1.getContext('2d');
  const ctx2 = c2.getContext('2d');
  const img1 = new Image();
  const img2 = new Image();
  const bcTmp = $('#barcodeTmp');

  // Inputs
  const f11 = $('#f11');
  const f12 = $('#f12');
  const f13 = $('#f13');
  const f14 = $('#f14');
  const f15 = $('#f15');
  const f21 = $('#f21');
  const f22 = $('#f22');
  const f23 = $('#f23');
  const rand15 = $('#rand15');
  const toggleCross = $('#toggleCross');

  const bcx = $('#bcx');
  const bcy = $('#bcy');
  const bcw = $('#bcw');
  const bch = $('#bch');

  // 初始化 1-5
  f15.value = randomCode(12);

  function fitCanvasToImage(canvas, img){
    const W = img.naturalWidth || 1000;
    const H = img.naturalHeight || 600;
    canvas.width = W; canvas.height = H;
  }

  function drawBase(ctx, canvas, img){
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    if(img && img.src){ ctx.drawImage(img,0,0,W,H); }
    else { makePlaceholder(ctx, W, H); }
  }

  function renderImage1(){
    drawBase(ctx1, c1, img1);
    const W = c1.width, H = c1.height;
    const p11 = drawText(ctx1, f11.value, layout1['1-1'], W, H);
    const p12 = drawText(ctx1, f12.value, layout1['1-2'], W, H);
    const p13 = drawText(ctx1, f13.value, layout1['1-3'], W, H);
    const p14 = drawText(ctx1, f14.value, layout1['1-4'], W, H);
    const p15 = drawText(ctx1, f15.value, layout1['1-5'], W, H);
    if(toggleCross.checked){ [p11,p12,p13,p14,p15].forEach(p=>cross(ctx1,p.x,p.y)); }
  }

  function renderBarcodeIntoTmp(value, targetW, targetH){
    // 先用 JsBarcode 畫在 tmp canvas，再縮放貼到主圖
    const tmp = bcTmp;
    const scale = window.devicePixelRatio || 1;
    const w = Math.max(100, Math.round(targetW*scale));
    const h = Math.max(40, Math.round(targetH*scale));
    tmp.width = w; tmp.height = h;
    const ok = (window.JsBarcode && typeof JsBarcode === 'function');
    const opts = { format:'code128', displayValue:true, font:"system-ui", fontSize: Math.round(h*0.18), margin: 2 };
    try{
      if(ok){
        JsBarcode(tmp, value || '', opts);
      } else {
        // 簡易 fallback：畫文字框
        const tctx = tmp.getContext('2d');
        tctx.fillStyle = '#fff'; tctx.fillRect(0,0,w,h);
        tctx.strokeStyle = '#000'; tctx.strokeRect(0,0,w,h);
        tctx.fillStyle = '#000'; tctx.font = `${Math.round(h*0.3)}px system-ui`; tctx.textAlign='center'; tctx.textBaseline='middle';
        tctx.fillText(value || '(no JsBarcode)', w/2, h/2);
      }
    }catch(err){
      console.warn('JsBarcode error:', err);
    }
  }

  function renderImage2(){
    drawBase(ctx2, c2, img2);
    const W = c2.width, H = c2.height;
    const p21 = drawText(ctx2, f21.value, layout2['2-1'], W, H);
    const p22 = drawText(ctx2, f22.value, layout2['2-2'], W, H);
    const p23 = drawText(ctx2, f23.value, layout2['2-3'], W, H);
    if(toggleCross.checked){ [p21,p22,p23].forEach(p=>cross(ctx2,p.x,p.y)); }

    // 條碼（來自 1-5）
    const code = f15.value || '';
    const targetW = Math.max(10, Math.round((Number(bcw.value)||60)/100 * W));
    const targetH = Math.max(10, Math.round((Number(bch.value)||20)/100 * H));
    renderBarcodeIntoTmp(code, targetW, targetH);
    const x = Math.round((Number(bcx.value)||8)/100 * W);
    const y = Math.round((Number(bcy.value)||48)/100 * H);
    ctx2.drawImage(bcTmp, x, y, targetW, targetH);
    if(toggleCross.checked){ cross(ctx2, x, y); }
  }

  function renderAll(){ renderImage1(); renderImage2(); }

  // 綁定事件
  ['input','change'].forEach(ev=>{
    [f11,f12,f13,f14,f15,f21,f22,f23,bcx,bcy,bcw,bch,toggleCross].forEach(el=> on(el, ev, renderAll));
  });

  on($('#img1'), 'change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) { img1.src=''; renderImage1(); return; }
    const url = URL.createObjectURL(f);
    img1.onload = ()=>{ fitCanvasToImage(c1, img1); renderImage1(); URL.revokeObjectURL(url); };
    img1.src = url;
  });

  on($('#img2'), 'change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) { img2.src=''; renderImage2(); return; }
    const url = URL.createObjectURL(f);
    img2.onload = ()=>{ fitCanvasToImage(c2, img2); renderImage2(); URL.revokeObjectURL(url); };
    img2.src = url;
  });

  on(rand15, 'click', ()=>{ f15.value = randomCode(12); renderAll(); });

  function downloadCanvas(canvas, filename){
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = filename; a.click();
  }
  on($('#dl1'), 'click', ()=> downloadCanvas(c1, 'image1.png'));
  on($('#dl2'), 'click', ()=> downloadCanvas(c2, 'image2.png'));

  on($('#clear1'), 'click', ()=>{ f11.value=''; f12.value=''; f13.value=''; f14.value=''; /* 保留 f15 以便條碼 */ renderAll(); });
  on($('#clear2'), 'click', ()=>{ f21.value=''; f22.value=''; f23.value=''; renderAll(); });

  // 設定固定底圖載入
  const BASE1_SRC = 'test_id_card_gen/img/ROC_ID_F.JPG';
  const BASE2_SRC = 'test_id_card_gen/img/ROC_ID_B.JPG';
  img1.onload = ()=>{ fitCanvasToImage(c1, img1); renderImage1(); };
  img2.onload = ()=>{ fitCanvasToImage(c2, img2); renderImage2(); };
  img1.src = BASE1_SRC; img2.src = BASE2_SRC;

  // 初始渲染（若底圖尚未載入，會先顯示佔位）
  renderAll();
})();
</script>
</body>
</html>
