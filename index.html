<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <title>測試證件產生器</title>
  <style>
    :root {
      --gap: 16px;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --bg: #f8fafc;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(180%) blur(6px);
      background: rgba(248, 250, 252, 0.8);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 700;
    }

    main {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
    }

    @media (min-width: 1024px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(2, 6, 23, 0.04);
    }

    .card h2 {
      margin: 0;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      font-size: 16px;
    }

    .card .content {
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      align-items: center;
    }

    .row.inline {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    select {
      appearance: none;
      width: 100%;
      background: white;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      color: var(--ink);
    }

    input[type="checkbox"] {
      transform: translateY(1px);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--line);
      background: #0ea5e9;
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
    }

    button.secondary {
      background: white;
      color: var(--ink);
    }

    canvas {
      width: 100%;
      height: auto;
      border: 1px dashed var(--line);
      border-radius: 12px;
      background: white;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f1f5f9;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #0f172a;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>

<body>
  <header>
    <h1>測試證件產生器</h1>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>證件正面</h2>
        <div class="content">
          <div class="row"><label>姓名</label><input id="id_name" type="text" value="姓名" /></div>
          <div class="row"><label>出生年</label><input id="birth_y" type="text" inputmode="numeric" pattern="[0-9]*"
              value="80" /></div>
          <div class="row"><label>出生月</label><input id="birth_m" type="text" inputmode="numeric" pattern="[0-9]*"
              value="10" /></div>
          <div class="row"><label>出生日</label><input id="birth_d" type="text" inputmode="numeric" pattern="[0-9]*"
              value="23" /></div>
          <div class="row"><label>發證年</label><input id="card_issue_y" type="text" inputmode="numeric" pattern="[0-9]*"
              value="103" /></div>
          <div class="row"><label>發證月</label><input id="card_issue_m" type="text" inputmode="numeric" pattern="[0-9]*"
              value="08" /></div>
          <div class="row"><label>發證日</label><input id="card_issue_d" type="text" inputmode="numeric" pattern="[0-9]*"
              value="22" /></div>
          <div class="row">
            <label>身分證字號</label>
            <div class="btns">
              <input id="id_number" type="text" value="" style="min-width:240px" />
              <button type="button" id="random_gen_id">隨機產生</button>
              <span class="hint">此號碼會帶入證件背面條碼部分</span>
            </div>
          </div>
          <div class="row">
          </div>
          <canvas id="canvas_front" width="1000" height="600"></canvas>
          <div class="btns">
            <button type="button" id="id_front_download">下載正面</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>證件背面</h2>
        <div class="content">
          <div class="row"><label>父</label><input id="father_name" type="text" value="父親名" /></div>
          <div class="row"><label>母</label><input id="mother_name" type="text" value="母親名" /></div>
          <div class="row"><label>配偶</label><input id="spouse_name" type="text" value="配偶名" /></div>
          <div class="row"><label>役別</label><input id="military" type="text" value="免役" /></div>
          <div class="row"><label>出生地</label><input id="born_place" type="text" value="台北市" /></div>
          <div class="row"><label>住址</label><input id="address" type="text" value="台北市信義區測試里99鄰預設路12號" /></div>

          <canvas id="canvas_back" width="1000" height="600"></canvas>
          <div class="btns">
            <button type="button" id="id_back_download">下載背面</button>
          </div>
        </div>

    </div>
    </section>
    </div>
  </main>

  <canvas id="barcode" width="600" height="160" style="display:none"></canvas>

  <script>
    (function () {
      // 固定版面配置（使用「百分比」定位，會依底圖解析度自動縮放）
      const layout_f = {
        'name': { x: 18, y: 49, fontH: 9 },
        'born_y': { x: 28, y: 68, fontH: 5 },
        'born_m': { x: 40, y: 68, fontH: 5 },
        'born_d': { x: 49, y: 68, fontH: 5 },
        'issued_y': { x: 24, y: 83, fontH: 5 },
        'issued_m': { x: 32.5, y: 83, fontH: 5 },
        'issued_d': { x: 39, y: 83, fontH: 5 },
        'card_id': { x: 68, y: 83, fontH: 5, bold: true },
      };

      const layout_b = {
        'father_name': { x: 14, y: 11, fontH: 6 },
        'mother_name': { x: 55, y: 11, fontH: 6 },
        'spouse_name': { x: 20, y: 25, fontH: 6 },
        'military': { x: 60, y: 25, fontH: 6 },
        'born_place': { x: 20, y: 38, fontH: 6 },
        'address': { x: 20, y: 54, fontH: 5 },
      };


      const $ = (sel) => document.querySelector(sel);
      const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

      function randomTaiwanID() {
        // 開頭英文字母為縣市，且有對應計算之值
        const letters = "ABCDEFGHJKLMNPQRSTUVXYWZIO";
        const cityLetter = letters[Math.floor(Math.random() * letters.length)];

        // 字母轉可計算值
        const letterCode = letters.indexOf(cityLetter) + 10;
        const tens = Math.floor(letterCode / 10);
        const ones = letterCode % 10;

        // 第二碼性別
        const genderDigits = Math.random() < 0.5 ? 1 : 2;

        // 隨機 7 碼
        let digits = "";
        for (let i = 0; i < 7; i++) {
          digits += Math.floor(Math.random() * 10);
        }

        const baseID = `${cityLetter}${genderDigits}${digits}`;

        // 計算檢查碼
        let sum = 0;
        sum += tens * 1 + ones * 9;
        sum += genderDigits * 8;
        for (let i = 0; i < 7; i++) {
          sum += parseInt(digits[i]) * (7 - i);
        }

        const checkCode = (10 - (sum % 10)) % 10;
        return baseID + checkCode;
      }

      function makePlaceholder(ctx, W, H) {
        ctx.fillStyle = '#f5f5f5';
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = '#e2e8f0';
        for (let y = 0; y < H; y += 40) { for (let x = 0; x < W; x += 40) { if (((x / 40 + y / 40) | 0) % 2 === 0) ctx.fillRect(x, y, 40, 40); } }
        ctx.fillStyle = '#475569';
        ctx.font = '700 24px system-ui';
        ctx.fillText('(未設定底圖)', 20, 40);
      }

      function drawText(ctx, text, conf, W, H) {
        const x = Math.round(conf.x / 100 * W);
        const y = Math.round(conf.y / 100 * H);
        const fontPx = Math.max(10, Math.round(conf.fontH / 100 * H));
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillStyle = '#111827';
        ctx.font = `${conf.bold ? '700' : '400'} ${fontPx}px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC`;
        ctx.fillText(text || '', x, y);
        return { x, y };
      }

      function cross(ctx, x, y) {
        ctx.save();
        ctx.strokeStyle = '#94a3b8';
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(x - 10, y); ctx.lineTo(x + 10, y);
        ctx.moveTo(x, y - 10); ctx.lineTo(x, y + 10);
        ctx.stroke();
        ctx.restore();
      }

      // Canvas
      const canvas_f = $('#canvas_front');
      const canvas_b = $('#canvas_back');
      const ctx_f = canvas_f.getContext('2d');
      const ctx_b = canvas_b.getContext('2d');
      const id_front = new Image();
      const id_back = new Image();
      const barcode = $('#barcode');

      // Inputs
      const id_name = $('#id_name');
      const birth_y = $('#birth_y');
      const birth_m = $('#birth_m');
      const birth_d = $('#birth_d');
      const card_issue_y = $('#card_issue_y');
      const card_issue_m = $('#card_issue_m');
      const card_issue_d = $('#card_issue_d');
      const id_number = $('#id_number');
      const father_name = $('#father_name');
      const mother_name = $('#mother_name');
      const spouse_name = $('#spouse_name');
      const random_gen_id = $('#random_gen_id');

      // Barcode settings
      const barcode_x = $('#barcode_x');
      const barcode_y = $('#barcode_y');
      const barcode_w = $('#barcode_w');
      const barcode_h = $('#barcode_h');

      // random id number
      id_number.value = randomTaiwanID();

      function fitCanvasToImage(canvas, img) {
        const W = img.naturalWidth || 1000;
        const H = img.naturalHeight || 600;
        canvas.width = W; canvas.height = H;
      }

      function drawBase(ctx, canvas, img) {
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0, 0, W, H);
        if (img && img.src) { ctx.drawImage(img, 0, 0, W, H); }
        else { makePlaceholder(ctx, W, H); }
      }

      function renderBarcodeIntoTmp(value, targetW, targetH) {
        // 先用 JsBarcode 畫在 tmp canvas，再縮放貼到主圖
        const tmp = barcode;
        const scale = window.devicePixelRatio || 1;
        const w = Math.max(100, Math.round(targetW * scale));
        const h = Math.max(40, Math.round(targetH * scale));
        tmp.width = w; tmp.height = h;
        const ok = (window.JsBarcode && typeof JsBarcode === 'function');
        const opts = { format: 'CODE128B', displayValue: true, font: "system-ui", fontSize: Math.round(h * 0.18), margin: 2 };
        try {
          if (ok) {
            JsBarcode(tmp, value || '', opts);
          } else {
            // 簡易 fallback：畫文字框
            const tctx = tmp.getContext('2d');
            tctx.fillStyle = '#fff'; tctx.fillRect(0, 0, w, h);
            tctx.strokeStyle = '#000'; tctx.strokeRect(0, 0, w, h);
            tctx.fillStyle = '#000'; tctx.font = `${Math.round(h * 0.3)}px system-ui`; tctx.textAlign = 'center'; tctx.textBaseline = 'middle';
            tctx.fillText(value || '(no JsBarcode)', w / 2, h / 2);
          }
        } catch (err) {
          console.warn('JsBarcode error:', err);
        }
      }

      function renderImageFront() {
        drawBase(ctx_f, canvas_f, id_front);
        const W = canvas_f.width, H = canvas_f.height;
        const p_id_name = drawText(ctx_f, id_name.value, layout_f['name'], W, H);
        const p_birth_y = drawText(ctx_f, birth_y.value, layout_f['born_y'], W, H);
        const p_birth_m = drawText(ctx_f, birth_m.value, layout_f['born_m'], W, H);
        const p_birth_d = drawText(ctx_f, birth_d.value, layout_f['born_d'], W, H);
        const p_card_issue_y = drawText(ctx_f, card_issue_y.value, layout_f['issued_y'], W, H);
        const p_card_issue_m = drawText(ctx_f, card_issue_m.value, layout_f['issued_m'], W, H);
        const p_card_issue_d = drawText(ctx_f, card_issue_d.value, layout_f['issued_d'], W, H);
        const p_id_number = drawText(ctx_f, id_number.value, layout_f['card_id'], W, H);
      }

      function renderImageBack() {
        drawBase(ctx_b, canvas_b, id_back);
        const W = canvas_b.width, H = canvas_b.height;
        const p_father_name = drawText(ctx_b, father_name.value, layout_b['father_name'], W, H);
        const p_mother_name = drawText(ctx_b, mother_name.value, layout_b['mother_name'], W, H);
        const p_spouse_name = drawText(ctx_b, spouse_name.value, layout_b['spouse_name'], W, H);
        const p_military = drawText(ctx_b, military.value, layout_b['military'], W, H);
        const p_born_place = drawText(ctx_b, born_place.value, layout_b['born_place'], W, H);
        const p_address = drawText(ctx_b, address.value, layout_b['address'], W, H);


        // barcode
        const code = id_number.value || '';
        const targetW = Math.max(10, Math.round((Number(35) || 60) / 100 * W));
        const targetH = Math.max(10, Math.round((Number(16) || 20) / 100 * H));
        renderBarcodeIntoTmp(code, targetW, targetH);
        const x = Math.round((Number(15) || 8) / 100 * W);
        const y = Math.round((Number(70) || 48) / 100 * H);
        ctx_b.drawImage(barcode, x, y, targetW, targetH);
      }

      function renderAll() { renderImageFront(); renderImageBack(); }

      // event
      ['input'].forEach(ev => {
        [id_name, birth_y, birth_m, birth_d, card_issue_y, card_issue_m, card_issue_d, id_number, father_name, mother_name, military, born_place, address, spouse_name, barcode_x, barcode_y, barcode_w, barcode_h].forEach(el => on(el, ev, renderAll));
      });

      on(random_gen_id, 'click', () => { id_number.value = randomTaiwanID(); renderAll(); });

      function downloadCanvas(canvas, filename) {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = filename; a.click();
      }
      on($('#id_front_download'), 'click', () => downloadCanvas(canvas_f, 'TW_ID_F_' + id_number.value + '.png'));
      on($('#id_back_download'), 'click', () => downloadCanvas(canvas_b, 'TW_ID_B_' + id_number.value + '.png'));

      // 設定固定底圖載入
      id_front.onload = () => { fitCanvasToImage(canvas_f, id_front); renderImageFront(); };
      id_back.onload = () => { fitCanvasToImage(canvas_b, id_back); renderImageBack(); };
      id_front.src = 'img/ROC_ID_F.JPG'; id_back.src = 'img/ROC_ID_B.JPG';

      // 初始渲染（若底圖尚未載入，會先顯示佔位）
      renderAll();
    })();
  </script>
</body>

</html>